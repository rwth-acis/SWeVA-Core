<!DOCTYPE html>
<html>

<head>
    <title>Core test page</title>
    <script src="./core.build.js"></script>
    <script src="./examplePipelines.js"></script>
    <script src="/node_modules/requirejs/require.js"></script>
</head>

<body>
    <span id="browser-sync-binding"></span>
    <h1>Open the browser console, to view the results</h1>
    Press the button, to run a simple test<br>
    <button onclick="runTests()">Start tests</button>

    <script>

        var manager = new sweva.ExecutionManager();

        async function runTests() {
            //await testModules()
            await testPipeLine1()
            //await testPipeline2()
        }

        async function testModules() {
            console.log("Starting Test of Modules");
            let ts = sweva.runners.typescript;
            let tsModule1 = {
                type: 'module',
                name: 'add',
                code: "",
                //create base64 uint8: btoa(String.fromCharCode.apply(null, uint8array))
                binary: new Uint8Array(atob(
                    "AGFzbQEAAAABGgVgAX8Bf2AAAGAEf39/fwBgAn9/AX9gAX8AAg0BA2VudgVhYm9ydAACAwcGAAMABAEBBQMBAAEGDAJ/AUEAC38" +
                    "AQZAJCwdFBwR0ZXN0AAEFX19uZXcAAgVfX3BpbgADB19fdW5waW4ABAlfX2NvbGxlY3QABQtfX3J0dGlfYmFzZQMBBm1lbW9yeQ" +
                    "IACAEGCpYCBjMBA39BASEBIABBAEoEQANAIABBAWsiAARAIAEgAmohAyABIQIgAyEBDAELCyABDwtBAAvKAQEGfyAAQez///8DS" +
                    "wRAQaAIQeAIQdYAQR4QAAALIABBEGoiB0H8////A0sEQEGgCEHgCEEhQR0QAAALIwAiBUEEaiICIAdBE2pBcHFBBGsiBGoiBj8A" +
                    "IgdBEHRBD2pBcHEiA0sEQCAHIAYgA2tB//8DakGAgHxxQRB2IgMgAyAHSBtAAEEASARAIANAAEEASARAAAsLCyAGJAAgBSAENgI" +
                    "AIAIiA0EEayIHQQA2AgQgB0EANgIIIAcgATYCDCAHIAA2AhAgA0EQagsEACAACwMAAQsDAAELBwBBrAkkAAsLggEFAEGMCAsBPA" +
                    "BBmAgLLwEAAAAoAAAAQQBsAGwAbwBjAGEAdABpAG8AbgAgAHQAbwBvACAAbABhAHIAZwBlAEHMCAsBPABB2AgLJQEAAAAeAAAAf" +
                    "gBsAGkAYgAvAHIAdAAvAHMAdAB1AGIALgB0AHMAQZAJCw0DAAAAIAAAAAAAAAAgAH0QYXMtYmluZF9iaW5kaW5nc3sidHlwZUlk" +
                    "cyI6e30sImltcG9ydGVkRnVuY3Rpb25zIjp7fSwiZXhwb3J0ZWRGdW5jdGlvbnMiOnsidGVzdCI6eyJyZXR1cm5UeXBlIjoiaTM" +
                    "yIiwicGFyYW1ldGVycyI6WyJpMzIiXX19fQ=="
                ).split("").map(function(c) {
                    return c.charCodeAt(0); }))
            };
            let tsModule2 = {
                type: 'module',
                name: 'substr',
                source: "export function test(pos: i32): string {\n" +
                    "\n" +
                    "    return \"hallo123\".substr(pos);\n" +
                    "  }\n"
            };

            console.log("Precompiled module:");
            var res1 = await ts.exec(tsModule1, 10);
            console.log(res1);


            console.log("Uncompiled module:");
            var res2 = await ts.exec(tsModule2, 3);
            console.log(res2);
        }

        async function testPipeLine1() {
            console.log("Starting Pipeline 1");
            var now = Date.now();
            manager.setup(simpleAssemblyScriptPipeline);
            manager.onProgress(function (progress) {
                console.log(progress+"%");
            });
            manager.execute({
                    "Node1": {
                        "in": 8
                    }
                }, 4).then(function (result) {
                console.log('time ' + (Date.now() - now) + 'ms');
                console.log(result);
            });
        }

        async function testPipeline2() {
            console.log("Starting Pipeline 2");
            var now = Date.now();
            manager.setup(simpleHTTPRequest);
            manager.onProgress(function (progress) {
              console.log(progress);
            });

            manager.execute({}, {
                "Filter1": {
                  "minRating": 1
                }
              }).then(function (result) {
                console.log('time ' + (Date.now() - now) + 'ms');
                console.log(result);
              });
        }


        /*function click(event) {

            var now = Date.now();
            manager.execute({
                adder1: {
                    sum1: 10,
                    sum2: 50
                },
                adder2: {
                    sum1: 5,
                    sum2: 15
                },
                clone1: {
                    sum1: 20,
                    sum2: 10
                }
            },
                {
                    offset: 0,
                    invert: 0
                })
                .then(function (result) {
                    console.log('time ' + (Date.now() - now) + 'ms');
                    console.log(result);
                });
        }*/

        runTests()
    </script>
</body>

</html>