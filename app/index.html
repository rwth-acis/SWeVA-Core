<!DOCTYPE html>
<html>

<head>
    <title>Core test page</title>
    <script src="../core.build.js"></script>
    <script src="./examplePipelines.js"></script>
    <script src="/node_modules/requirejs/require.js"></script>
</head>

<body>
    <span id="browser-sync-binding"></span>
    <h1>Open the browser console, to view the results</h1>
    Press the button, to run a simple test<br>
    <button onclick="runTests()">Start tests</button>

    <script>

        var manager = new sweva.ExecutionManager();

        async function runTests() {
            //await testPrecompiledModule()
            //await testSourceModule()
            await testPipeLine1()
            //await testPipeline2()
        }

        async function testPrecompiledModule() {
            console.log("Starting Test of Modules");
            console.log("Precompiled module:");
            let tsModule1 = {
                type: 'module',
                name: 'add',
                code: "",
                dataInNames: ["a", "b"],
                inputNames: [],
                outputNames: ["out"],
                //create base64 uint8: btoa(String.fromCharCode.apply(null, uint8array))
                binary: new Uint8Array(atob(
                    "AGFzbQEAAAABGgVgAn9/AX9gAABgBH9/f38AYAF/AX9gAX8AAg0BA2VudgVhYm9ydAACAwcGAAADBAEBBAQBcAABBQMBAAEGDAJ" +
                    "/AUEAC38AQZAJCwdMCANydW4AAQVfX25ldwACBV9fcGluAAMHX191bnBpbgAECV9fY29sbGVjdAAFC19fcnR0aV9iYXNlAwEGbW" +
                    "Vtb3J5AgAFdGFibGUBAAgBBgroAQYHACAAIAFqC8gBAQZ/IABB7P///wNLBEBBoAhB4AhB1gBBHhAAAAsgAEEQaiIEQfz///8DS" +
                    "wRAQaAIQeAIQSFBHRAAAAsjACIDQQRqIgIgBEETakFwcUEEayIEaiIFPwAiBkEQdEEPakFwcSIHSwRAIAYgBSAHa0H//wNqQYCA" +
                    "fHFBEHYiByAGIAdKG0AAQQBIBEAgB0AAQQBIBEAACwsLIAUkACADIAQ2AgAgAkEEayIDQQA2AgQgA0EANgIIIAMgATYCDCADIAA" +
                    "2AhAgAkEQagsEACAACwMAAQsDAAELBwBBrAkkAAsLggEFAEGMCAsBPABBmAgLLwEAAAAoAAAAQQBsAGwAbwBjAGEAdABpAG8Abg" +
                    "AgAHQAbwBvACAAbABhAHIAZwBlAEHMCAsBPABB2AgLJQEAAAAeAAAAfgBsAGkAYgAvAHIAdAAvAHMAdAB1AGIALgB0AHMAQZAJC" +
                    "w0DAAAAIAAAAAAAAAAgAIIBEGFzLWJpbmRfYmluZGluZ3N7InR5cGVJZHMiOnt9LCJpbXBvcnRlZEZ1bmN0aW9ucyI6e30sImV4" +
                    "cG9ydGVkRnVuY3Rpb25zIjp7InJ1biI6eyJyZXR1cm5UeXBlIjoiaTMyIiwicGFyYW1ldGVycyI6WyJpMzIiLCJpMzIiXX19fQ=="
                ).split("").map(function (c) {
                    return c.charCodeAt(0);
                }))
            };
            var res1 = await sweva.runners.typescript.exec(tsModule1, {a: 5, b: 15});
            console.log("Result: "+res1);
        }

        async function testSourceModule() {
            let tsModule2 = {
                type: 'module',
                name: 'substr',
                source: [
                    "export var testvar1:i32 = 7888;",
                    "export var testvar8:i8[] = [1,2,3];",
                    "export var testvar32:i32[] = [1,2,300];",
                    "export var testvar3:string[] = [\"a\",\"b\",\"c\"];",
                    "export function z(a: i32): i32 {",
                    "return 1; }\n",
                    "export function run(pos: i32,b: string[]): string {",
                    "    return b[pos];",
                    "  }"]
            };

            console.log("Uncompiled module:");
            var res2 = await sweva.runners.typescript.exec(tsModule2, {pos: 3, b: ["a1", "b2", "b3", "b4"]}, {});
            console.log("Result: "+res2);
        }

        async function testPipeLine1() {
            console.log("Starting Pipeline 1");
            var now = Date.now();
            manager.setup(simpleAssemblyScriptPipeline);
            manager.onProgress(function (progress) {
                console.log(progress+"%");
            });
            manager.execute({
                    "Node1": {
                        "num": 8
                    }
                }, {}).then(function (result) {
                console.log('time ' + (Date.now() - now) + 'ms');
                console.log(result);
            });
        }

        async function testPipeline2() {
            console.log("Starting Pipeline 2");
            var now = Date.now();
            manager.setup(simpleHTTPRequest);
            manager.onProgress(function (progress) {
              console.log(progress);
            });

            manager.execute({}, {
                "Filter1": {
                  "minRating": 1
                }
              }).then(function (result) {
                console.log('time ' + (Date.now() - now) + 'ms');
                console.log(result);
              });
        }


        /*function click(event) {

            var now = Date.now();
            manager.execute({
                adder1: {
                    sum1: 10,
                    sum2: 50
                },
                adder2: {
                    sum1: 5,
                    sum2: 15
                },
                clone1: {
                    sum1: 20,
                    sum2: 10
                }
            },
                {
                    offset: 0,
                    invert: 0
                })
                .then(function (result) {
                    console.log('time ' + (Date.now() - now) + 'ms');
                    console.log(result);
                });
        }*/

        runTests()
    </script>
</body>

</html>